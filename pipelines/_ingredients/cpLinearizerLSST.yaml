description: cp_pipe linearizer calibration construction.
tasks:
  cpLinearizerIsr:
    class: lsst.ip.isr.IsrTaskLSST
    config:
      connections.ccdExposure: "raw"
      connections.outputExposure: "cpLinearizerIsrExp"
      python: |
        from lsst.cp.pipe import configureIsrTaskLSSTForCalibrations

        configureIsrTaskLSSTForCalibrations(config)

        config.doBootstrap = True
        config.doCrosstalk = True
        config.crosstalk.doQuadraticCrosstalkCorrection = False
        config.doDefect = True
  cpLinearizerPtcExtractPair:
    class: lsst.cp.pipe.ptc.PhotonTransferCurveExtractPairTask
    config:
      connections.inputExp: "cpLinearizerIsrExp"
      connections.outputCovariance: "cpLinearizerPtcPartial"
      connections.outputBinnedImages: "cpLinearizerPtcPairBinned"
      maximumRangeCovariancesAstier: 1
      numEdgeSuspect: 20
      edgeMaskLevel: "AMP"
      useEfdPhotodiodeData: true
      auxiliaryHeaderKeys: ["TEMP6"]
      doOutputBinnedImages: true
  cpLinearizerPtcSolve:
    class: lsst.cp.pipe.ptc.PhotonTransferCurveSolveTask
    config:
      connections.inputCovariances: "cpLinearizerPtcPartial"
      connections.outputPtcDataset: "linearizerPtc"
      # This is just used as a placeholder.
      ptcFitType: "EXPAPPROXIMATION"
      maximumRangeCovariancesAstier: 1
      maximumRangeCovariancesAstierFullCovFit: 1
  cpLinearizerUnnormalizedSolve1:
    class: lsst.cp.pipe.LinearityDoubleSplineSolveTask
    config:
      useFocalPlaneNormalization: false
      connections.inputBinnedImagesHandles: "cpLinearizerPtcPairBinned"
      connections.outputLinearizer: "linearizerUnnormalized1"
      usePhotodiode: true
      absoluteSplineLowThreshold: 0.0
      absoluteSplineNodeSize: 10000.0
  cpLinearizerNormalize1:
    class: lsst.cp.pipe.LinearityNormalizeTask
    config:
      connections.inputLinearizerHandles: "linearizerUnnormalized1"
      connections.outputNormalization: "cpLinearizerNormalization1"
  cpLinearizerUnnormalizedSolve2:
    class: lsst.cp.pipe.LinearityDoubleSplineSolveTask
    config:
      useFocalPlaneNormalization: true
      connections.inputNormalization: "cpLinearizerNormalization1"
      connections.inputBinnedImagesHandles: "cpLinearizerPtcPairBinned"
      connections.outputLinearizer: "linearizerUnnormalized2"
      usePhotodiode: true
  cpLinearizerNormalize2:
    class: lsst.cp.pipe.LinearityNormalizeTask
    config:
      connections.inputLinearizerHandles: "linearizerUnnormalized2"
      connections.outputNormalization: "cpLinearizerNormalization2"
  cpLinearizerSolve:
    class: lsst.cp.pipe.LinearityDoubleSplineSolveTask
    config:
      useFocalPlaneNormalization: true
      connections.inputNormalization: "cpLinearizerNormalization2"
      connections.inputBinnedImagesHandles: "cpLinearizerPtcPairBinned"
      connections.outputLinearizer: "linearizer"
      usePhotodiode: true

subsets:
  cpLinearizerPtc:
    subset:
      - cpLinearizerIsr
      - cpLinearizerPtcExtractPair
      - cpLinearizerPtcSolve
contracts:
  - cpLinearizerIsr.doBootstrap == True
  - cpLinearizerPtcExtractPair.connections.inputExp == cpLinearizerIsr.connections.outputExposure
  - cpLinearizerPtcSolve.binSize == cpLinearizerPtcExtractPair.binSize
  - cpLinearizerPtcSolve.maximumRangeCovariancesAstier == cpLinearizerPtcExtractPair.maximumRangeCovariancesAstier
  - cpLinearizerPtcSolve.connections.inputCovariances == cpLinearizerPtcExtractPair.connections.outputCovariance
  - cpLinearizerSolve.connections.inputLinearizerPtc == cpLinearizerPtcSolve.connections.outputPtcDataset
